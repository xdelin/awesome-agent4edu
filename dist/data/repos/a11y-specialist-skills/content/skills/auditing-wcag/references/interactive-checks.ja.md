[English](./interactive-checks.md)

# インタラクティブチェック

ユーザー操作をPlaywrightで再現して判定する項目。キーボード/ポインター/エラー処理など、状態遷移が絡む基準を扱います。

## 共通手順
- 主要フローをキーボードで通過（Tab/Shift+Tab/Enter/Space/矢印）
- ポインター操作を模擬（click/drag/hover）
- DOM差分とa11y treeで状態変化を記録

## キーボード
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 2.1.1 | すべての機能をキーボードのみで実行 | 操作ログ/動画 | クリック専用操作がある |
| 2.1.2 | すべてのフォーカスを抜けられる | 操作ログ | フォーカストラップがある |
| 2.1.4 | 文字キー単独ショートカットの無効化/再割当/フォーカス限定 | 操作ログ | ショートカットが誤発火し回避不可 |

## フォーカス
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 2.4.3 | フォーカス順序が視覚順と一致 | フォーカス順ログ | 大きく順序が崩れる |
| 2.4.7 | フォーカス可視化を確認 | スクショ/動画 | フォーカスが視認不可 |
| 2.4.11 | フォーカス表示が最低要件を満たす | スクショ/計測 | コントラスト/太さが不足 |
| 2.4.12 | フォーカスが他のコンテンツに隠されない | スクショ | 固定ヘッダー/フッター/モーダルでフォーカスが隠れる |

### フォーカス可視化チェックスクリプト

`scripts/focus-indicator-check.ts` を使用して、フォーカスインジケーターの有無、フォーカス遮蔽、フォーカス時のコンテキスト変更を自動検出できます。

**WCAG カバレッジ:**
- **2.4.7 Focus Visible** - フォーカスインジケーターがない要素を検出
- **2.4.12 Focus Not Obscured (Minimum)** - fixed/sticky要素によるフォーカス遮蔽を検出
- **3.2.1 On Focus** - フォーカス時のナビゲーション/コンテキスト変更を検出

**機能:**
- ページ内のフォーカス可能な要素を自動検出
- Tab キーで各要素にフォーカスを移動し、スタイル変化をキャプチャ
- フォーカス時のスタイル変化を検出（outline, box-shadow, background-color, border, transform 等）
- フォーカススタイルがない要素を赤枠と警告ラベルでマーク
- **fixed/sticky要素によるフォーカス遮蔽を検出（2.4.12）** - `elementFromPoint()` とz-indexフォールバックを使用
- **フォーカスによるナビゲーションを検出（3.2.1違反）**
- ナビゲーション発生時は元のページに戻ってスクリーンショットを撮影
- 全ページスクリーンショットで問題箇所を視覚化

**使用方法:**
```bash
# デフォルトのテストページ
npx playwright test scripts/focus-indicator-check.ts

# カスタムURL
TEST_PAGE="https://example.com" npx playwright test scripts/focus-indicator-check.ts
```

**出力:**
- `focus-indicator-result.json` - 完全な結果:
  - `issues` - フォーカススタイルがない要素（2.4.7）
  - `focusObscuredIssues` - fixed/sticky要素によるフォーカス遮蔽（2.4.12）
  - `onFocusViolations` - フォーカス時のコンテキスト変更（3.2.1）
  - `interrupted` - ナビゲーションによりテストが中断されたかどうか
  - `allElements` - テストした全要素とフォーカススタイルの差分
- `focus-indicators.png` - 問題のある要素に警告ラベルを付けた全ページスクリーンショット

**3.2.1 検出:**
要素のフォーカスイベントがナビゲーションを引き起こした場合:
1. 違反が記録される（要素セレクター、遷移元/先URL）
2. テストは元のページに戻る
3. 元のページでスクリーンショットを撮影
4. テストは中断としてマークされる

**依存関係:**
```bash
npm install @playwright/test
```

## ポインター
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 2.5.7 | ドラッグ以外の操作手段を提供 | 操作ログ | ドラッグ必須で代替なし |
| 2.5.8 | ターゲットサイズを測定 | スクショ/計測 | 最低サイズを満たさない |

### ターゲットサイズチェックスクリプト

`scripts/target-size-check.ts` を使用して、WCAG 2.5.8（AA: 24px）および 2.5.5（AAA: 44px）に基づくタップ/クリックターゲットのサイズを自動測定できます。

**機能:**
- すべてのインタラクティブ要素を検出（リンク、ボタン、入力、ARIAウィジェット）
- `getBoundingClientRect()` でバウンディングボックスサイズを測定
- Playwright の `ariaSnapshot()` API でアクセシブル名を取得
- WCAG 2.5.8 例外を判定: inline, redundant, ua-control, spacing
- AA（24px）と AAA（44px）の両レベルで問題を報告
- 色分けハイライト付きの全ページスクリーンショットを生成

**使用方法:**
```bash
# デフォルトのテストページ
npx playwright test scripts/target-size-check.ts

# カスタムURL
TEST_PAGE="https://example.com" npx playwright test scripts/target-size-check.ts
```

**出力:**
- `target-size-result.json` - すべてのターゲットと問題を含む完全な結果
- `target-size-screenshot.png` - ハイライト付き全ページスクリーンショット:
  - **緑 (PASS)**: 44px以上（AA合格、AAA合格）
  - **オレンジ (AA Pass)**: 24-43px（AA合格、AAA不合格）
  - **赤 (AA Fail)**: 24px未満（AA不合格、AAA不合格）
  - **青 (Exception)**: 例外の可能性あり（手動レビュー必要）

**検出される例外:**
| 例外 | 検出方法 |
|---|---|
| inline | 段落/リスト内のリンクで周囲テキストが10文字以上 |
| redundant | 同じhrefを持つ別のターゲットがサイズ要件を満たしている |
| ua-control | ネイティブフォームコントロール（checkbox, radio, select）でデフォルト外観 |
| spacing | 24px以内に隣接ターゲットがない |
| essential | 自動検出不可（手動レビュー対象としてマーク） |

**制限事項:**
- essential 例外は手動判断が必要
- クリック領域を拡張するCSS疑似要素は完全に検出できない
- CSS transform の効果は測定に含まれる（getBoundingClientRect は変換後のサイズを返す）

**手動確認が必要な項目:**
- essential 例外の確認（例: 地図のピン、ゲームコントロール）
- spacing 例外の実際のインタラクションでの検証
- インタラクション後にのみ表示されるターゲット（ドロップダウン、モーダル）

## ホバー/フォーカス表示
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 1.4.13 | ホバー/フォーカスで出るコンテンツを閉じ/保持可能 | 操作ログ/動画 | 逃げ場なし、意図せず消える |

## エラー処理
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 3.3.1 | エラー入力時に識別が提示 | スクショ | エラー箇所が不明 |
| 3.3.3 | 修正提案が表示 | スクショ | 具体的な修正提案なし |
| 3.3.4 | 重要操作の再確認/取消が可能 | 操作ログ | 取消/確認がない |

### 3.3.1 エラーの特定チェック

**概要:** 入力エラーが自動的に検出された場合、エラーとなっている項目がテキストで識別され、そのエラーがユーザーに説明される必要がある。

> **Note:** 3.3.1をテストする際、以下も同時に確認:
> - **3.3.2 ラベルまたは説明** — エラーを発生させる前に、フォーム入力にアクセシブル名と説明があるかチェック。3.3.2の詳細は [automated-checks.ja.md](./automated-checks.ja.md) を参照。
> - **3.3.3 エラー修正の提案** — エラーメッセージに修正方法の提案があるかチェック（例:「name@example.com のような有効なメールアドレスを入力してください」）。

**テスト手順:**

1. **ページ内のフォームを検出:**
   - `<form>` 要素を検出
   - 入力フィールド（`input`, `select`, `textarea`）を検出
   - 必須フィールドを確認（`required` 属性、`aria-required="true"`、または視覚的インジケーター）

2. **意図的にエラーを発生させる:**

   | エラータイプ | 方法 |
   |------------|--------|
   | 必須フィールドの空送信 | フィールドを空にしてフォームを送信 |
   | 無効なメールアドレス | メールフィールドに "invalid-email" を入力 |
   | 無効な日付 | 日付フィールドに "not-a-date" を入力 |
   | 無効な電話番号 | 電話番号フィールドに "abc" を入力 |
   | 範囲外の値 | min/max 制限外の値を入力 |
   | パターン不一致 | `pattern` 属性に合わない値を入力 |

3. **エラーの識別を確認:**

   | チェック項目 | Pass条件 | Fail条件 |
   |-------|---------------|----------------|
   | エラーメッセージの存在 | エラーを説明するテキストメッセージがある | メッセージがない、または視覚的表現のみ（色/アイコン） |
   | エラー箇所の明示 | どのフィールドがエラーかテキストから明確 | 色や位置のみに依存 |
   | プログラム的関連付け | `aria-describedby`, `aria-errormessage`, `aria-invalid` がある | エラーとフィールド間のプログラム的なリンクがない |

4. **a11y tree での確認:**
   - エラーフィールドに `aria-invalid="true"` があるか確認
   - `aria-describedby` または `aria-errormessage` がエラーテキストを指しているか確認
   - エラーメッセージがa11y treeに公開されているか確認（ATから隠されていない）

**Playwright テストフローの例:**
```typescript
// 1. フォームと必須入力を検出
const form = page.locator('form').first();
const requiredInput = form.locator('input[required], input[aria-required="true"]').first();

// 2. 入力をクリアして送信しエラーを発生
await requiredInput.fill('');
await form.locator('button[type="submit"], input[type="submit"]').click();

// 3. エラー表示を確認
const a11ySnapshot = await page.accessibility.snapshot();
// スナップショットでaria-invalid, aria-describedbyを確認
// エラーメッセージテキストが公開されているか確認
```

**Passの条件:**
- エラーメッセージがテキストで表示される
- エラーメッセージがどのフィールドにエラーがあるか識別している
- エラーがフィールドとプログラム的に関連付けられている（推奨）

**Failの条件:**
- エラーメッセージが表示されない
- エラーが色のみで示される（テキスト説明なしの赤い枠/文字）
- エラーメッセージがどのフィールドのエラーか示していない
- エラーメッセージがATで認識できない（例: 視覚的アイコンのみ）

## 認証
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 3.3.8 | 認証で認知負荷のみを要求しない | 画面キャプチャ | 認知テストのみで代替なし |

## 自動再生検出

対象基準:
- **1.4.2** (音声の制御): 自動再生音声を停止/制御できる
- **2.2.2** (一時停止、停止、非表示): 自動更新コンテンツを一時停止/停止できる

### 自動再生検出スクリプト

`scripts/auto-play-detection.ts` を使用して、ピクセルレベルのスクリーンショット比較による自動再生コンテンツを検出できます。

**機能:**
- 2秒間隔でスクリーンショットを撮影（0秒, 2秒, 4秒, 6秒）
- ピクセルレベルの差分検出（pixelmatch）で正確な比較
- 5秒以上コンテンツが継続するかを検出（WCAG 2.2.2 の閾値）
- ページ内の一時停止/停止コントロールを自動検出
- 一時停止コントロールをクリックして実際に機能するか検証
- 変化箇所をハイライトした差分画像を生成
- アクセシビリティ推奨事項を含むレポートを出力

**使用方法:**
```bash
# スクリプト内のURLを変更して実行
npx playwright test scripts/auto-play-detection.ts
```

**出力:**
- `auto-play-screenshots/` - 以下を含むディレクトリ:
  - `screenshot-0s.png` ～ `screenshot-6s.png` - 比較用スクリーンショット
  - `diff-*-vs-*.png` - 変化したピクセルを示す差分画像
  - `detection-result.json` - 完全な検出結果:
    - 各間隔の変化率
    - 5秒以内に停止するか
    - 検出された一時停止コントロール（アクセシビリティ情報付き）
    - 一時停止コントロールの検証結果

**依存関係:**
```bash
npm install @playwright/test pixelmatch pngjs
npm install -D @types/pngjs
```

**一時停止コントロール検出:**
スクリプトは以下の方法で一時停止/停止コントロールを自動検索します:
- 一時停止関連キーワードを含むアクセシブル名（英語/日本語対応）
- クラス名パターン（pause, play, stop, toggle, switch, control）
- コンテキスト認識（カルーセル要素近くのコントロールを優先）

**一時停止コントロール検証:**
自動再生が検出され、5秒以上継続する場合:
1. 一時停止コントロールが見つかった → クリック実行
2. クリック前後でスクリーンショットを撮影
3. 比較してアニメーションが実際に停止したか確認
4. コントロールが機能するかどうかをレポート

**制限事項:**
- 視覚的変化のみ検出（カルーセル、アニメーション、動画再生）
- 音声の自動再生は手動確認が必要（聴覚確認）
- 0.1%未満の小さなアニメーションは検出されない場合あり

**手動確認が必要な項目:**
- 一時停止/停止コントロールがキーボードでアクセス可能か確認
- 音声の自動再生を聴覚で確認（スクリーンショットでは検出不可）
- 一時停止コントロール検証が失敗した場合、手動でコントロール機能を確認
