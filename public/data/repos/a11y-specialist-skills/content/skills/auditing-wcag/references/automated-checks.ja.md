[English](./automated-checks.md)

# 自動チェック (Playwright a11y tree)

Playwrightのアクセシビリティツリーから機械的に判定できる項目のみを扱います。判定は「Fail/Pass/NT/NA」を明示し、証跡はa11y treeスナップショットまたはDOM断片を保存します。

> **スクリプト:** `scripts/axe-audit.ts` はaxe-coreによる包括的な自動チェックを提供し、以下の多くの基準に加えて追加ルールもカバーします。まず実行して広範囲をカバーし、その後手動チェックで補完してください。

## 判定ルールの共通方針
- 取得元: `page.accessibility.snapshot()` / DOM属性
- 証跡: 要素のロール、名前、関連属性、XPath/CSSセレクタ
- Fail条件: ルールに一致しない要素が1件でもある

## 構造・セマンティクス
| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 1.3.1 | 見出し/ランドマーク/リスト/テーブルが適切なロールで表現されている | a11y tree断片 | 意味的に必要な要素が全てプレーンテキスト扱いになる |
| 1.3.2 | a11y treeの順序がDOM順と一致している | a11y tree + DOM順 | 読み上げ順がDOM順と矛盾する構造がある |
| 2.4.1 | 主要ブロックを飛ばす手段の存在（スキップリンク / mainランドマーク / メインコンテンツ内の見出し） | a11y tree（リンク名、ランドマーク、見出し構造） | スキップリンク・mainランドマーク・適切な見出しのいずれもない |
| 2.4.2 | ページタイトルが空でない | `document.title` | タイトル未設定/空文字 |
| 2.4.6 | 見出し/ラベルにアクセシブルネームがある | a11y treeのname | 見出し/ラベルが無名 |

## 代替テキスト
| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 1.1.1 | 画像のアクセシブルネーム有無（`alt`/`aria-label`等） | a11y tree | 情報性のある画像が無名 |
| 3.3.2 | フォーム入力にラベルまたは説明が紐付いている | a11y tree + DOM | 入力要素が無名/説明不足 |

## 時間依存メディア
| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 1.2.1 | 音声/映像のみにテキスト代替がある | DOM + a11y tree | メディア要素の近くにトランスクリプトリンクなし |
| 1.2.2 | 映像にキャプションがある | axe video-caption + DOM | `<video>` に `<track kind="captions">` なし |
| 1.2.3 | 映像に音声解説またはメディア代替がある | DOM | `<video>` に `<track kind="descriptions">` なし、トランスクリプトリンクもなし |
| 1.2.5 | 映像に音声解説がある | DOM | `<video>` に `<track kind="descriptions">` なし |

> **1.2.x チェック:** メディア要素を検出し、代替を確認：
>
> 1. **メディア検出:** `<video>`, `<audio>`, 埋め込みプレーヤー（YouTube/Vimeoの`<iframe>`）を検出
> 2. **トラック確認:**
>    - 1.2.2 用に `<track kind="captions">`
>    - 1.2.3, 1.2.5 用に `<track kind="descriptions">`
> 3. **代替確認:**
>    - 近くに「transcript」「text version」「文字起こし」「代替テキスト」等のリンク
>    - テキスト代替を指す `aria-describedby`
>
> **制限事項:**
> - キャプション/音声解説の品質・正確性は確認不可
> - トランスクリプトが必要な音声のみコンテンツは検出困難
> - 埋め込みプレーヤー（YouTube/Vimeo）は独自のキャプションシステムあり — 手動確認にフラグ
>
> **Pass:** メディアに適切なtrack要素または近くに代替リンクあり
> **Fail:** メディア要素にtrackなし、代替も検出されず

## ARIA
| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 4.1.2 | ロール/名前/値が取得可能 | a11y tree | インタラクティブ要素が無名/ロール不明 |
| 4.1.3 | ステータスメッセージが適切なロールで露出 | a11y tree | 状態変化がrole="status"等で表出しない |
| 2.5.3 | 視覚ラベルの文字列がアクセシブルネームに含まれる | DOMテキスト + a11y name | ラベル文字列がnameに含まれない |

## 色・コントラスト
| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 1.4.1 | UI識別に色名を使用しているテキスト | a11y treeのテキスト | 色名がUI要素の識別や情報伝達に使用されている |
| 1.4.3 | テキストコントラスト比がAA基準を満たす | axe color-contrast | 4.5:1未満（通常）または3:1未満（大きい文字） |
| 1.4.11 | 非テキスト要素のコントラストがAA基準を満たす | axe非テキストコントラストルール | 3:1未満 |

> **1.4.1 チェックA - テキスト参照:** アクセシブルなテキスト内の色名参照（赤、青、緑、レッド、ブルー等）を探し、色だけに依存していないか確認：
> - 指示: 「必須項目は赤字」「緑のボタンをクリック」
> - 状態: 「エラーは赤で表示」「空きは緑」
> - データラベル: 「赤=メアリー、青=トム」
>
> **Pass:** 色と形状/シンボルを併用している場合（例: 「赤い丸」「緑の三角アイコン」「青い四角ボタン」）
>
> **Fail:** 色のみで識別し、形状/シンボルの言及がない場合
>
> 「赤字経営」のような慣用表現と、実際の色依存を区別して判断する。
>
> **1.4.1 チェックB - テキスト内リンク (F73):** 文章中のリンクは色だけに依存せず視覚的に区別できる必要がある：
> - **Pass:** リンクに下線がある、または他の非色手段（枠線、アイコン、太字等）がある
> - **Pass:** リンク色と周囲テキストのコントラスト比が3:1以上 かつ hover/focus時に追加の視覚的手がかりがある
> - **Fail:** リンクに下線がなく、周囲テキストとのコントラスト比が3:1未満
>
> axe-coreの`link-in-text-block`ルールでカバーされる。axe結果でこのルールを確認。
>
> **1.4.1 チェックC - 視覚的状態の区別:** スクリーンショットで同じ形状の要素が色のみで区別されている場合、a11y treeで状態がプログラム的に公開されているか確認：
>
> | 視覚パターン | 必要なセマンティクス |
> |-------------|---------------------|
> | 選択中タブ（色が違う） | `aria-selected="true"` |
> | 現在のナビ項目（色が違う） | `aria-current="page"` |
> | カレンダーの今日（色が違う） | `aria-current="date"` |
> | エラーフィールド（赤枠） | `aria-invalid="true"` |
> | 必須フィールド（色が違う） | `aria-required="true"` または `required` |
> | 無効ボタン（グレーアウト） | `aria-disabled="true"` または `disabled` |
>
> **Pass:** a11y treeで状態が公開されている。 **Fail:** 色だけが唯一の区別手段。

> **Note:** axe-coreは複雑な背景画像やグラデーションのコントラストをチェックできません。一部のケースでは手動確認が必要な場合があります。

## 感覚的な特徴
| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 1.3.3 | 感覚的手がかりだけに依存しない指示 | a11y treeテキスト | プログラム的な代替なしの感覚依存指示 |

> **1.3.3 チェック:** アクセシブルテキスト内の感覚的特徴への参照を探し、感覚だけに依存していないか確認：
>
> | 感覚タイプ | 例 |
> |-----------|-----|
> | 位置 | 「右側の」「左のメニュー」「上の」「下の」「隣の」 |
> | 形 | 「丸いボタン」「四角いアイコン」「三角の」 |
> | サイズ | 「大きいボタン」「小さいリンク」 |
> | 音 | 「ビープ音が鳴ったら」「チャイムの後」 |
> | 視覚 | 「画像を見て」「図のように」「ハイライトされた部分」 |
>
> **Pass:** 感覚的手がかりとプログラム的識別子を併用（例: 「右側の送信ボタン」「丸い検索アイコン」）
>
> **Fail:** 感覚的手がかりのみで要素を識別（例: 「右のボタンをクリック」で他の識別子なし）
>
> 注: 1.4.1の色チェックより抽象的。文脈を考慮して判断。

## 入力目的
| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 1.3.5 | 入力フィールドに適切なautocomplete属性がある | autocomplete-audit.ts | ユーザーデータフィールドでautocomplete欠落/不正 |

> **スクリプト:** `scripts/autocomplete-audit.ts` - フィールド名/ラベルから期待されるautocompleteトークンと照合し、欠落・不正値を報告。

## 言語
| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 3.1.1 | `<html lang>`が有効な言語タグ | DOM属性 | lang未設定/無効 |
| 3.1.2 | 部分の言語が識別されている | DOM + a11y treeテキスト | 外国語テキストにlang属性なし |

> **3.1.2 チェック:** 2段階のチェック：
>
> 1. **axe-core `valid-lang` ルール:** 要素の無効なlang属性値を検出
>
> 2. **外国語テキスト検出:** ページの主言語と異なる言語のコンテンツを探す：
>    - 異なる文字体系のテキストを検出（例: 英語ページ内の日本語、日本語ページ内のラテン文字）
>    - よくある外国語フレーズ/単語を検出
>    - 含まれる要素に適切な`lang`属性があるか確認
>
> **Pass:** 外国語テキストが正しい`lang`属性で囲まれている（例: `<span lang="en">English</span>`）
> **Fail:** 外国語テキストに`lang`属性がない
>
> 注: 短い借用語（例: 「カフェ」「寿司」）はlang属性不要な場合あり。文脈で判断。

## リンク/ボタン
| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 2.4.4 | リンクのアクセシブルネームが空でなく曖昧でない | a11y tree | 空/無名または文脈なしで曖昧なリンク |
| 3.2.1 | フォーカス時に意図しないコンテキスト変更がない（DOM差分で検知） | DOM差分ログ | フォーカスのみでページ遷移や大幅な更新 |
| 3.2.2 | 入力変更時に自動送信/遷移がない（DOM差分で検知） | DOM差分ログ | 入力操作のみで送信/遷移 |

> **2.4.4 チェック:** 2段階の自動チェック：
>
> 1. **空リンク:** axe-coreの`link-name`ルールでアクセシブルネームなしのリンクを検出
>
> 2. **文脈なしの曖昧なリンク:** 汎用的なテキストでonly-child（周囲に文脈なし）のリンクを検出：
>    - 汎用用語: 「こちら」「詳細」「もっと見る」「続きを読む」「click here」「here」「more」「read more」「learn more」「details」「continue」
>    - 親要素内でonly-child（兄弟テキストによる文脈なし）かどうか
>    - `aria-describedby`や`aria-labelledby`による文脈がないかどうか
>
> **Pass:** 説明的なリンクテキスト、または汎用テキストでも周囲に文脈あり
>
> **Fail:** 汎用リンクテキスト かつ only-child かつ プログラム的文脈なし

## ページ横断チェック

全監査対象ページからデータを収集した後に実行するチェック。a11y treeスナップショットとリンクデータを全ページから収集後に判定。

| 基準 | 自動チェック | 証跡 | Fail条件 |
|---|---|---|---|
| 2.4.5 | ページへの到達手段が複数ある | リンクグラフ + 検索/サイトマップ検出 | 単一経路のみで検索/サイトマップなし |
| 3.2.3 | 同一サイト内で主要ナビゲーションの構造が一致 | a11y tree比較 | ナビゲーション構造が大きく異なる |
| 3.2.4 | 同一機能のコンポーネントが同一ロール/名前で表現 | a11y tree比較 | 同一機能の名前/ロールが不一致 |
| 3.2.6 | ヘルプ手段（FAQ/連絡先等）が一貫して提供 | a11y tree比較 | あるページだけヘルプが欠落 |

> **2.4.5 チェック:** 全監査対象ページからリンクを収集後：
>
> 1. リンクグラフ構築: 各ページから全`<a href>`を抽出
> 2. 複数手段の確認:
>    - **検索:** 検索フォームを検出（`role="search"`、`input[type="search"]`、または検索関連ラベルのフォーム）
>    - **サイトマップ:** サイトマップページを検出（テキスト/hrefに「sitemap」を含むリンク）— 監査対象にサイトマップを含めることを推奨
>    - **相互リンク:** 各ページが複数のページからリンクされている
> 3. 到達可能性分析:
>    - 1つのソースからのみリンク かつ 検索なし かつ サイトマップなし → 潜在的問題
>
> **Pass:** サイトに検索あり、またはサイトマップあり、またはページが複数ソースから相互リンク
> **Fail:** 単一ナビゲーション経路のみで代替手段なし

> **3.2.3 チェック:** 繰り返しナビゲーションの構造を比較：
>
> 1. ランドマーク領域を抽出: `banner`（ヘッダー）、`navigation`、`contentinfo`（フッター）
> 2. 各ランドマーク内の子構造をページ間で比較：
>    - ナビ項目の相対順序が同じ（アクセシブルネームで照合）
>    - 対応する項目のロールが同じ
> 3. 以下は許容：
>    - 現在ページ表示の違い（例: 異なる項目に`aria-current="page"`）
>    - 一部ページで項目が省略されていても、残りの項目が**相対的に同じ順序**を維持
>
> **相対的に同じ順序の例外:** ページ1が「A, B, C, D」、ページ2が「A, C, D」（Bが省略）の場合、A→C→Dの順序が維持されているため**Pass**。ただし「A, D, C」は**Fail**。
>
> **Pass:** 共有ナビ項目の相対順序が全ページで一貫
> **Fail:** ナビ項目の相対順序がページ間で異なる
